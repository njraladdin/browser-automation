<!DOCTYPE html>
<html>
<head>
  <title>Web Automation Builder</title>
  <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>Web Automation Builder</h1>
        <div class="status" id="status"></div>
      </div>
      <div class="control-panel">
        <button onclick="executeSteps()" class="btn btn-primary automation-btn" id="playButton">
          <span class="btn-icon">â–¶</span>
          <span class="btn-text">Start Automation</span>
          <span class="btn-loader"></span>
        </button>
        <button onclick="resetExecution()" class="btn btn-secondary">
          <span class="btn-icon">â†º</span> Reset
        </button>
        <button onclick="clearSteps()" class="btn btn-secondary">
          <span class="btn-icon">âœ•</span> Clear All
        </button>
      </div>
    </div>

    <main class="main-content">
      <div class="steps-container">
        <div id="stepsList" class="steps-list"></div>
      </div>
    </main>
  </div>

  <script>
    let steps = [];
    let lastExecutedStep = -1;

    // Initialize with first empty step
    window.onload = () => {
      if (steps.length === 0) {
        updateStepsList();
      }
    };

    async function addStep(stepNumber) {
      const input = document.querySelector(`#step-input-${stepNumber}`);
      if (!input || !input.value) return;

      const instructions = input.value;
      const stepBlock = document.querySelector(`#step-${stepNumber}`);
      const addButton = stepBlock.querySelector('.btn-primary');
      
      // Disable the input and button, show loading state
      input.disabled = true;
      addButton.disabled = true;
      stepBlock.classList.add('loading');
      
      try {
        const response = await fetch('/step', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ instructions })
        });
        
        const data = await response.json();
        if (data.success) {
          steps.push({ instructions, code: data.code });
          updateStepsList();
          showStatus('Step added successfully!');
          stepBlock.classList.remove('loading');
        } else {
          showStatus(`Error: ${data.error}`);
          // Re-enable the input and button if there's an error
          input.disabled = false;
          addButton.disabled = false;
          stepBlock.classList.remove('loading');
        }
      } catch (error) {
        showStatus(`Error: ${error.message}`);
        // Re-enable the input and button if there's an error
        input.disabled = false;
        addButton.disabled = false;
        stepBlock.classList.remove('loading');
      }
    }

    function updateStepsList() {
      const stepsList = document.getElementById('stepsList');
      
      const stepsHtml = steps.map((step, index) => `
        <div class="step-block ${index <= lastExecutedStep ? 'executed' : ''}" id="step-${index + 1}">
          <div class="step-marker ${index <= lastExecutedStep ? 'executed' : ''} ${index === lastExecutedStep + 1 ? 'current' : ''}"></div>
          <div class="step-line ${index <= lastExecutedStep ? 'executed' : ''}"></div>
          <div class="step-content">
            <div class="step-number ${index <= lastExecutedStep ? 'executed' : ''}">${index + 1}</div>
            <div class="step-input-container">
              <input type="text" value="${step.instructions}" class="step-input" readonly />
            </div>
            ${step.screenshot 
              ? `<img src="${step.screenshot}" alt="Step ${index + 1} result" class="step-screenshot" />`
              : `<div class="step-screenshot">No screenshot yet</div>`
            }
          </div>
          <div class="code-block">
            <div class="code-content">${step.code}</div>
          </div>
        </div>
      `).join('');

      const newStepNumber = steps.length + 1;
      const newStepHtml = `
        <div class="step-block new-step" id="step-${newStepNumber}">
          <div class="step-marker"></div>
          <div class="step-line"></div>
          <div class="step-content">
            <div class="step-number">${newStepNumber}</div>
            <div class="step-input-container">
              <div class="step-label">
                ðŸ‘‰ ${newStepNumber === 1 ? "First step" : "Next step"}
              </div>
              <input type="text" 
                id="step-input-${newStepNumber}" 
                placeholder="Go to website, click button, type text..."
                class="step-input"
                onkeypress="if(event.key === 'Enter') addStep(${newStepNumber})" />
            </div>
            <button onclick="addStep(${newStepNumber})" class="btn btn-primary">
              Add
            </button>
          </div>
        </div>
      `;

      stepsList.innerHTML = stepsHtml + newStepHtml;
    }

    async function executeSteps() {
      const playButton = document.getElementById('playButton');
      const btnText = playButton.querySelector('.btn-text');
      
      playButton.classList.add('loading');
      btnText.textContent = 'Running...';
      
      try {
        const response = await fetch('/execute', {
          method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
          lastExecutedStep = data.lastExecutedStep;
          steps = data.steps;
          updateStepsList();
          showStatus('Steps executed successfully!');
        } else {
          showStatus(`Error: ${data.error}`);
        }
      } catch (error) {
        showStatus(`Error: ${error.message}`);
      } finally {
        playButton.classList.remove('loading');
        btnText.textContent = 'Start Automation';
      }
    }

    async function executeAllSteps() {
      await resetExecution();
      await executeSteps();
    }

    async function resetExecution() {
      const status = document.getElementById('status');
      
      try {
        await fetch('/reset-execution', { method: 'POST' });
        lastExecutedStep = -1;
        updateStepsList();
        status.textContent = 'Execution reset to beginning';
      } catch (error) {
        status.textContent = `Error: ${error.message}`;
      }
    }

    async function clearSteps() {
      const status = document.getElementById('status');
      
      try {
        await fetch('/clear', { method: 'POST' });
        steps = [];
        updateStepsList();
        status.textContent = 'All steps cleared';
      } catch (error) {
        status.textContent = `Error: ${error.message}`;
      }
    }

    async function closeBrowser() {
      const status = document.getElementById('status');
      
      try {
        await fetch('/close', { method: 'POST' });
        status.textContent = 'Browser closed';
      } catch (error) {
        status.textContent = `Error: ${error.message}`;
      }
    }

    function showStatus(message) {
      const status = document.getElementById('status');
      if (!status) return; // Guard clause
      
      status.textContent = message;
      status.classList.add('visible');
      
      setTimeout(() => {
        status.classList.remove('visible');
      }, 3000);
    }
  </script>
</body>
</html> 